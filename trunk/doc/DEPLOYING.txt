Kosmos File System (KFS).

Created on 2007/08/23

Copyright (C) 2007 Kosmix Corp.

This file is part of Kosmix File System (KFS).

KFS is free software: you can redistribute it and/or modify it under
the terms of the GNU General Public License as published by the Free
Software Foundation under version 3 of the License.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

Sriram Rao
Kosmix Corp.
sriram@kosmix.com (sriram at kosmix dot com)

CONTENTS:
=========
 * DEPLOYING KFS
 * DEFINING THE MACHINE CONFIGURATION
 * INSTALLING KFS BINARIES
 * RUNNING KFS
 * MONITORING KFS SERVERS
 * INCREMENTAL SCALING: ADDING NEW SERVERS

DEPLOYING KFS
=============

To deploy KFS, we assume that you can login into the target machines
via ssh without a password.

There are two modes of deployment:
 - Single machine setting: The metaserver/chunkserver run on the same,
 single machine
 - Distributed setting: The servers run on a cluster of machines.

In either mode, the steps are the same.  For ease of explanation, we
assume that the machine from which the software was installed is the
same the as one from which the servers will be started/stopped.

DEFINING THE MACHINE CONFIGURATION
==================================

The format of this file follows a Python config file: [...] defines a
section---in our case, a server <key>: <value> is used to
configuration for the server The file is expected to have exactly 1
[metaserver] section; there can be as many chunkserver sections as
there are chunk servers.  For simplicity, chunkserver sections are
defined as [chunkserver1]...[chunkserverN]

For either type of server, the configuration file defines three
variables:
 * node:  This variable specifies the node on which the server should
 be installed and run.

 * rundir: This variable specifies the directory on the node where the
 binaries should be installed (see next section).  When multiple
 servers are run on the same node, this variable should contain unique
 values for each server.

 * baseport: On a node, this variable uniquely defines the port at
 which the server is listening for incoming connections.  In KFS,
 inter-process communication---between meta
 server/chunkserver(s)/applications---is via TCP sockets.  Now,
    - When multiple servers are run on the same node, this variable
      should be assigned a unique value for each server. 
    - When servers are run on different nodes, by definition, the
      values are unique.  Consequently, all servers can be configured
      to listen on the same port # on the node.

For the chunkservers, there is are two additional variables that are defined:
  * space:  This variable, defines in bytes, the amount of storage
  space exported by that chunkserver.  
  * chunkdir: This variable is optional.  When specified, this defines
  the directory the chunkserver should use to store the chunks.  

By default, 
 - meta server's checkpoint/log files are stored in
 ${rundir}/bin/kfscp and ${rundir}/bin/kfslog
 - chunkserver's checkpoint/log files are stored in
 ${rundir}/bin/logs
 - chunkserver's chunks are stored in ${rundir}/bin/chunks.  This
 value is overridden when "chunkdir" variable is defined for a chunkserver.

NOTE: It is not advisable to change the default location for either
server's checkpoint/log files.  Changing them adversely affects the
other helper scripts that are provided (such as, backing up the meta
server's logs/checkpoint files, periodically cleaning out old
checkpoint/log files).

INSTALLING KFS BINARIES
=======================
To simplify the software deployment, scripts are included in the
distribution.  Assuming ~/code/kfs is the root of the tree,
~/code/kfs/scripts contains the necessary scripts and sample machine
configuration files.

To install the KFS binaries, perform the following steps:

1. Build the software (see COMPILING.txt)
2. cd ~/code/kfs/scripts
3. Create config file that describes the machine setup.  These are the
machines on which KFS servers will be deployed. For sample config files, see:
       - ~/code/kfs/conf/machines_local.cfg.sample: for setting up KFS on a single machine
       - ~/code/kfs/conf/machines_distributed.cfg.sample: for setting up KFS on a cluster of
          machines
4. Run setup script to get the binaries copied over and the necessary
directories made.  The setup script requires two arguments:
   i) machines config file: ~/code/kfs/scripts/machines.cfg
   ii) path to the bin directory containing the metaserver/chunkserver
   binaries, namely, ~/code/kfs/build/bin, type the following:

 python kfssetup.py -f machines.cfg -b ../build/bin

The setup script does the following steps:
 - It creates a kfspkg.tgz comprising of the appropriate binary
 (metaserver/chunkserver), scripts, and uses scp/ssh to copy and
 install the package on each of the nodes
 - On the target node, the setup script copies the kfspkg.tgz to /tmp
 directory.  
 - The model used by the script works for statically linked
 metaserver/chunkserver binaries.  If these binaries were built with
 dynamic linkage, simply copying the binaries to remote machines may
 not work.  You will need to deploy libraries, setup the
 LD_LIBRARY_PATH and such to make it work.  This is NOT supported by
 the current script.

RUNNING KFS
===========

After you have deployed the KFS software on all the target machines,
helper scripts are included in the distribution to start/stop the
servers.

 Starting the servers:
 =====================
 1. cd ~/code/kfs/scripts 
 2. python kfslaunch.py -f machines.cfg --start

 This script reads the machines.cfg file and starts up the appropriate
 server on a given target machine.  
  - For the metaserver, the metaserver binary as well as script to
 periodically clean out old checkpoint/log files. 
  - For the chunkserver, the chunkserver binary as well as script to
 periodically clean out old checkpoint/log files. 

 For both metaserver/chunkserver, whenever a new checkpoint is taken
 (which also causes a log rotation to occur), the old checkpoint/logs
 are not deleted.  To prevent accumulation of these old files,
 periodic cleanup is done by the script.

 If the server was previously running on the target machine, then
 there is no effect on the target machine due to this script.

 Stopping the servers:
 ======================
 1. cd ~/code/kfs/scripts 
 2. python kfslaunch.py -f machines.cfg --stop

 This script reads the machines.cfg file and stops the appropriate
 server on a given target machine.


MONITORING KFS SERVERS
======================

To monitor KFS servers, you can use use ~/code/kfs/build/bin/KfsPing
tool.  This tool can be used to:
   - ping the metaserver to determine how many chunkservers are
     connected to it
   - ping the chunkserver to determine which chunkserver it is
     connected to 

Type KfsPing -h to know its usage.

After kfslaunch.py is used to start the servers, KfsPing can be used
to verify that (1) the servers have been started on the appropriate
machines, and (2) the chunkservers are connected to the metaserver.

INCREMENTAL SCALING: ADDING NEW SERVERS
=======================================

To add new chunkservers to the setup, perform the following steps:

1. Add the new chunkservers to the machines.cfg file (i.e,
   ~/code/kfs/scripts/machines.cfg)
2. Install the KFS binaries on the new machines (see the section about
   INSTALLING KFS BINARIES).  The install script will only install
   binaries if they don't exist on the target machine.
3. Start the chunkservers on the new nodes.  See "Starting the
   servers" in the RUNNING KFS section.  The launch script will only
   start (1) the new chunkservers, and (2) any old chunkservers that
   may have been stopped.  When the new chunkservers startup, they
   announce themselves to the metaserver and get included in the system.
